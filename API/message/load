#! /usr/bin/ruby

require 'rubygems'
require 'rack'
require 'xml'
require '../functions/connect.rb'

$dbh=dbconnect

class MessageLoad
	def call(env)
		req = Rack::Request.new(env)
		
		$dbh.ping()

		c=req.query_string();
		if(!c)
			c="";
		end

		if(c=="die")
		    abort
		elsif c=="bbox"
		    #   bboxarray = c.split(/([(0-9)(\.?(0-9)*)?],?[(0-9)(\.?(0-9)*)?]*)/)

		    puts YAML::dump(c)
		    puts "query: ",c

		    bboxarray = c.split(",")
=begin
		    puts bboxarray[0]
		    puts bboxarray[1]
		    puts bboxarray[2]
		    puts bboxarray[3]

=end
		end #End if



		begin
			sql="SELECT id,X(wgs),Y(wgs),message,time_stamp  FROM `geopoints` LIMIT 10"

			st=$dbh.prepare(sql);

			st.execute

			xml = "<gts  query='message/load[#{c}]' >";

			while row = st.fetch do
				xml += "<content lat='#{row[1]}' lon='#{row[2]}' user='' id='#{row[0]}' timestamp='#{row[4]}'>";
				xml =xml+ row[3];
				xml += "</content>";
			end


			xml =xml+ '</gts>';
			return  [200, {"Content-Type" => "text/xml"}, [xml]]

		rescue Exception => e
			xml = "<error no='6'>DB Error: #{e.message}.</error>"
			return[500,{"Content-Type" => "text/xml"},[xml]]
			
		end

	end
end

Rack::Handler::FastCGI.run MessageLoad.new
